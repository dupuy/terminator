#!/bin/bash
#
# Generate minimum version requirements file
#
if [ "$#" -lt 2 ]; then
  echo >&2 "Usage: minvers MINVERS REQFILES..."
  exit 1
fi

set -e
trap '[ "$?" != 127 ] && echo >&2 $0: "\"$BASH_COMMAND\" failed ($?)"' ERR

MINVERS=$1
shift

# trap removes partial/empty target on failure
settrap() { trap 'if [ "$?" != 0 ]; then rm -f $MINVERS; fi' 0; }

MSG="`echo \"Generated by 'make requirements' from $*\" | fmt | sed 's/^/# /'`
# You should not need to edit this file - see requirements/README.rst"

if grep '^[^#-].*>[^=]' "$@"; then
  echo "Use '>=' not '>' for requirements"; exit 1
fi
if egrep -v '^($|-[er]|#)|>|==' "$@"; then
  echo "Minimum version unspecified for requirements"; exit 1
fi
echo "creating $MINVERS"
settrap       
{
  echo "$MSG"
  # requirements for foobar[extra,another] are handled just as foobar
  # regex replaces:         (py-pkg-name)   >=|==  (version-num)   pkg==vers
  cat "$@" | sed -n -e 's/^\([^[,<!=>]*\).*[>=]= *\([^,<!=> ]*\).*$/\1==\2/p'
} > $MINVERS
